name: Build with docling-parse FFI

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake pkg-config libssl-dev
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Build C++ library
      run: |
        chmod +x build_cpp.sh
        ./build_cpp.sh
    
    - name: Build Rust with FFI
      run: |
        cargo build --release --features 'pdf,cli,docling-ffi'
    
    - name: Run tests
      run: |
        export LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH
        cargo test --features 'pdf,docling-ffi'
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: transmutation-linux-ffi
        path: |
          target/release/transmutation
          target/release/libdocling_ffi.so
  
  build-macos:
    name: Build on macOS
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew install cmake
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Build C++ library
      run: |
        chmod +x build_cpp.sh
        ./build_cpp.sh
    
    - name: Build Rust with FFI
      run: |
        cargo build --release --features 'pdf,cli,docling-ffi'
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: transmutation-macos-ffi
        path: |
          target/release/transmutation
          target/release/libdocling_ffi.dylib
  
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
    
    - name: Build C++ library
      run: |
        .\build_cpp.ps1
    
    - name: Build Rust with FFI
      run: |
        cargo build --release --features 'pdf,cli,docling-ffi'
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: transmutation-windows-ffi
        path: |
          target/release/transmutation.exe
          target/release/docling_ffi.dll

