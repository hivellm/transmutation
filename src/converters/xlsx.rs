//! XLSX converter implementation
//! 
//! Follows Docling's pipeline: XLSX â†’ PDF (via LibreOffice) â†’ Parse as PDF
//! This reuses the existing PDF conversion infrastructure.

use super::traits::{ConverterMetadata, DocumentConverter};
use super::pdf::PdfConverter;
use crate::types::{ConversionOptions, ConversionResult, ConversionOutput, FileFormat, OutputFormat, OutputMetadata};
use crate::Result;
use async_trait::async_trait;
use std::path::Path;
use std::process::Command;
use tokio::fs;

/// XLSX to Markdown/CSV converter
/// 
/// Uses LibreOffice to convert XLSX â†’ PDF, then processes as PDF
pub struct XlsxConverter {
    pdf_converter: PdfConverter,
}

impl XlsxConverter {
    /// Create a new XLSX converter
    pub fn new() -> Self {
        Self {
            pdf_converter: PdfConverter::new(),
        }
    }
    
    /// Convert XLSX to PDF using LibreOffice
    async fn xlsx_to_pdf(&self, path: &Path) -> Result<std::path::PathBuf> {
        eprintln!("ðŸ“Š Converting XLSX to PDF (LibreOffice)...");
        
        let temp_dir = std::env::temp_dir().join(format!("transmutation_xlsx_{}", std::process::id()));
        fs::create_dir_all(&temp_dir).await?;
        
        // Detect OS and use appropriate LibreOffice command
        let (libreoffice_cmd, install_msg) = if cfg!(target_os = "windows") {
            ("soffice.exe", "Install LibreOffice from https://www.libreoffice.org/download/")
        } else if cfg!(target_os = "macos") {
            ("/Applications/LibreOffice.app/Contents/MacOS/soffice", "Install: brew install libreoffice")
        } else {
            ("libreoffice", "Install: sudo apt install libreoffice")
        };
        
        let output = Command::new(libreoffice_cmd)
            .arg("--headless")
            .arg("--convert-to")
            .arg("pdf")
            .arg("--outdir")
            .arg(&temp_dir)
            .arg(path)
            .output()
            .map_err(|e| crate::TransmutationError::engine_error(
                "libreoffice",
                format!("Failed to run LibreOffice: {}.\n{}", e, install_msg)
            ))?;
        
        if !output.status.success() {
            let stderr = String::from_utf8_lossy(&output.stderr);
            let _ = fs::remove_dir_all(&temp_dir).await;
            return Err(crate::TransmutationError::engine_error(
                "libreoffice",
                format!("LibreOffice failed: {}", stderr)
            ));
        }
        
        // Find generated PDF
        let filename = path.file_stem().and_then(|s| s.to_str()).unwrap_or("spreadsheet");
        let pdf_path = temp_dir.join(format!("{}.pdf", filename));
        
        if !pdf_path.exists() {
            let _ = fs::remove_dir_all(&temp_dir).await;
            return Err(crate::TransmutationError::engine_error(
                "libreoffice",
                "PDF not generated by LibreOffice".to_string()
            ));
        }
        
        let pdf_size = pdf_path.metadata()?.len();
        eprintln!("      âœ“ PDF: {} KB", pdf_size / 1024);
        
        Ok(pdf_path)
    }
}

impl Default for XlsxConverter {
    fn default() -> Self {
        Self::new()
    }
}

#[async_trait]
impl DocumentConverter for XlsxConverter {
    fn supported_formats(&self) -> Vec<FileFormat> {
        vec![FileFormat::Xlsx]
    }

    fn output_formats(&self) -> Vec<OutputFormat> {
        vec![
            OutputFormat::Markdown {
                split_pages: false,
                optimize_for_llm: true,
            },
            OutputFormat::Csv {
                delimiter: ',',
                include_headers: true,
            },
        ]
    }

    async fn convert(
        &self,
        input: &Path,
        output_format: OutputFormat,
        options: ConversionOptions,
    ) -> Result<ConversionResult> {
        eprintln!("ðŸ”„ XLSX Conversion Pipeline (Docling-style)");
        eprintln!("   XLSX â†’ PDF â†’ Parse â†’ Markdown");
        eprintln!();
        
        // Step 1: Convert XLSX to PDF
        let pdf_path = self.xlsx_to_pdf(input).await?;
        
        // Step 2: Convert PDF to desired format using existing PDF pipeline
        eprintln!("ðŸ“„ Parsing PDF (reusing PDF converter)...");
        let result = self.pdf_converter.convert(&pdf_path, output_format, options).await?;
        
        // Step 3: Cleanup temporary PDF
        let temp_dir = pdf_path.parent().unwrap();
        let _ = fs::remove_dir_all(temp_dir).await;
        
        eprintln!("âœ… XLSX conversion complete!");
        Ok(result)
    }

    fn metadata(&self) -> ConverterMetadata {
        ConverterMetadata {
            name: "XLSX Converter".to_string(),
            version: env!("CARGO_PKG_VERSION").to_string(),
            description: "XLSX to Markdown converter (via LibreOffice â†’ PDF pipeline)".to_string(),
            external_deps: vec!["LibreOffice".to_string()],
        }
    }
}

